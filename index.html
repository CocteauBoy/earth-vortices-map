<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Earth Vortices – Interactive Chakra Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html, body { height: 100dvh; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:#0b1321; color:#eef2f7; }
    #map { height: 100dvh; width: 100vw; }
    .panel { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(8,12,24,0.85); padding: 12px 14px; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; backdrop-filter: blur(6px); max-width: 360px; transition: transform 0.25s ease; }
    .title { font-weight: 700; font-size: 16px; margin-bottom: 8px; letter-spacing: 0.3px; }
    .legend-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.25); }
    .chakra-label { flex: 1; font-size: 13px; }
    .toggle { margin-left: 6px; }
    .note { font-size: 12px; color: #aab3c2; margin-top: 8px; line-height: 1.35; }
    .filter-header { font-weight: 600; margin-top: 8px; margin-bottom: 4px; font-size: 13px; color:#cfe5ff; }
    .category { font-size: 12px; color:#c6d0de; margin-bottom: 4px; }
    .credits { position: absolute; right: 10px; bottom: 10px; z-index: 1000; background: rgba(8,12,24,0.75); padding: 6px 10px; border-radius: 10px; font-size: 12px; border: 1px solid rgba(255,255,255,0.08); }
    a, a:visited { color:#a6d3ff; }
    #togglePanelBtn { position:absolute; top:10px; right:10px; z-index:1001; background:#1c2538; color:#fff; border:none; border-radius:8px; padding:6px 10px; font-size:13px; cursor:pointer; }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      .panel { max-width: 92vw; top: 8px; left: 8px; padding: 10px 12px; }
      .title { font-size: 14px; }
      .chakra-label { font-size: 12px; }
      #togglePanelBtn { padding: 5px 9px; font-size: 12px; top: 8px; right: 8px; }
    }
  </style>
</head>
<body>
  <button id="togglePanelBtn">Hide Filters</button>
  <div class="panel" id="filterPanel">
    <div class="title">Earth Vortices – Primary and Secondary Chakras</div>
    <div class="legend">
      <!-- Chakra toggles -->
      <div class="legend-row"><div class="swatch" style="background:#D72638"></div><div class="chakra-label">Root</div><input class="toggle" type="checkbox" data-chakra="root" checked/></div>
      <div class="legend-row"><div class="swatch" style="background:#F46036"></div><div class="chakra-label">Sacral</div><input class="toggle" type="checkbox" data-chakra="sacral" checked/></div>
      <div class="legend-row"><div class="swatch" style="background:#F7C948"></div><div class="chakra-label">Solar</div><input class="toggle" type="checkbox" data-chakra="solar" checked/></div>
      <div class="legend-row"><div class="swatch" style="background:#2ECC71"></div><div class="chakra-label">Heart</div><input class="toggle" type="checkbox" data-chakra="heart" checked/></div>
      <div class="legend-row"><div class="swatch" style="background:#277DA1"></div><div class="chakra-label">Throat</div><input class="toggle" type="checkbox" data-chakra="throat" checked/></div>
      <div class="legend-row"><div class="swatch" style="background:#574AE2"></div><div class="chakra-label">Brow</div><input class="toggle" type="checkbox" data-chakra="brow" checked/></div>
      <div class="legend-row"><div class="swatch" style="background:#9D4EDD"></div><div class="chakra-label">Crown</div><input class="toggle" type="checkbox" data-chakra="crown" checked/></div>
      <div class="filter-header">Filter</div>
      <div class="category"><label><input id="togglePrimaries" type="checkbox" checked/> Show Primaries</label></div>
      <div class="category"><label><input id="toggleSecondaries" type="checkbox" checked/> Show Secondaries</label></div>
      <div class="note">Hover over a location to highlight its connections. Click a location for details. Use the toggles to filter by chakra and category.</div>
    </div>
  </div>
  <div id="map"></div>
  <div class="credits">Map tiles © <a href="https://carto.com/" target="_blank" rel="noopener">Carto</a> · Engine © <a href="https://leafletjs.com/" target="_blank" rel="noopener">Leaflet</a></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // UI: Show or hide the filter panel
    document.getElementById('togglePanelBtn').addEventListener('click', function(){
      const panel = document.getElementById('filterPanel');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        this.textContent = 'Hide Filters';
      } else {
        panel.style.display = 'none';
        this.textContent = 'Show Filters';
      }
    });

    // Chakra colors
    const CHAKRA_COLORS = {
      root:   '#D72638',   // red
      sacral: '#F46036',   // orange
      solar:  '#F7C948',   // yellow
      heart:  '#2ECC71',   // green
      throat: '#277DA1',   // blue
      brow:   '#574AE2',   // indigo
      crown:  '#9D4EDD'    // violet
    };

    // Popup template
    function popupHtml(node) {
      return `<div style="min-width:220px">`
        + `<div style=\"font-weight:700;font-size:14px;margin-bottom:4px\">${node.name}</div>`
        + `<div style=\"font-size:12px;color:#aab3c2;margin-bottom:6px\">${node.level.toUpperCase()} · ${node.chakraLabel}</div>`
        + (node.notes ? `<div style=\"font-size:12px;line-height:1.35\">${node.notes}</div>` : '')
        + `</div>`;
    }

    // Data, updated to match the transcript precisely
    const nodes = [
      // Primaries
      { id:'root_primary',    name:'Mount Shasta, California, USA', lat:41.409, lng:-122.194, chakra:'root', level:'primary', chakraLabel:'Root' },
      { id:'sacral_primary',  name:'Lake Titicaca region, Peru–Bolivia', lat:-15.75, lng:-69.42, chakra:'sacral', level:'primary', chakraLabel:'Sacral' },
      { id:'solar_primary',   name:'Uluru–Kata Tjuta, Northern Territory, Australia', lat:-25.345, lng:131.036, chakra:'solar', level:'primary', chakraLabel:'Solar Plexus' },
      { id:'heart_primary',   name:'Glastonbury–Shaftesbury area, England', lat:51.149, lng:-2.717, chakra:'heart', level:'primary', chakraLabel:'Heart' },
      { id:'throat_primary',  name:'Great Pyramid and Giza Plateau, Egypt', lat:29.979, lng:31.134, chakra:'throat', level:'primary', chakraLabel:'Throat' },
      { id:'brow_primary',    name:'Mount Kailash, Tibet (mobile in cycles)', lat:31.067, lng:81.311, chakra:'brow', level:'primary', chakraLabel:'Brow / Third Eye' },
      { id:'crown_primary',   name:'Sedona, Arizona, USA', lat:34.869, lng:-111.760, chakra:'crown', level:'primary', chakraLabel:'Crown' },

      // Secondaries – Root
      { id:'crater_lake', name:'Crater Lake, Oregon, USA', lat:42.944, lng:-122.110, chakra:'root', level:'secondary', chakraLabel:'Root' },
      { id:'black_hills', name:'Black Hills, South Dakota, USA', lat:44.000, lng:-103.500, chakra:'root', level:'secondary', chakraLabel:'Root' },
      { id:'banff', name:'Banff and Lake Louise, Alberta, Canada', lat:51.178, lng:-115.570, chakra:'root', level:'secondary', chakraLabel:'Root' },
      { id:'fuji', name:'Mount Fuji, Japan', lat:35.3606, lng:138.7274, chakra:'root', level:'secondary', chakraLabel:'Root' },
      { id:'table_mountain', name:'Table Mountain, South Africa', lat:-33.9628, lng:18.4098, chakra:'root', level:'secondary', chakraLabel:'Root' },

      // Secondaries – Sacral
      { id:'iguazu', name:'Iguazú Falls, Argentina–Brazil border', lat:-25.695, lng:-54.436, chakra:'sacral', level:'secondary', chakraLabel:'Sacral' },
      { id:'easter_island', name:'Easter Island, Chile', lat:-27.1127, lng:-109.3497, chakra:'sacral', level:'secondary', chakraLabel:'Sacral' },
      { id:'oaxaca', name:'Oaxaca, Mexico', lat:17.073, lng:-96.726, chakra:'sacral', level:'secondary', chakraLabel:'Sacral' },
      { id:'bali', name:'Bali, Indonesia', lat:-8.4095, lng:115.1889, chakra:'sacral', level:'secondary', chakraLabel:'Sacral' },
      { id:'seychelles', name:'Seychelles Islands', lat:-4.6796, lng:55.4920, chakra:'sacral', level:'secondary', chakraLabel:'Sacral' },

      // Secondaries – Solar Plexus
      { id:'wollumbin', name:'Mount Warning (Wollumbin), New South Wales, Australia', lat:-28.391, lng:153.271, chakra:'solar', level:'secondary', chakraLabel:'Solar Plexus' },
      { id:'adams_peak', name:'Adam\'s Peak (Sri Pada), Sri Lanka', lat:6.8097, lng:80.4992, chakra:'solar', level:'secondary', chakraLabel:'Solar Plexus' },
      { id:'canary_islands', name:'Canary Islands', lat:28.293, lng:-16.621, chakra:'solar', level:'secondary', chakraLabel:'Solar Plexus' },
      { id:'mount_kenya', name:'Mount Kenya, Kenya', lat:0.1521, lng:37.3084, chakra:'solar', level:'secondary', chakraLabel:'Solar Plexus' },
      { id:'atlantic_ridge', name:'Atlantic Ridge (Canary–Azores–Madeira system)', lat:30.0, lng:-25.0, chakra:'solar', level:'secondary', chakraLabel:'Solar Plexus', notes:'Submerged volcanic-tectonic ridge lines linking Canary Islands to Azores and Madeira; diminished by modern interference in some maps.' },

      // Secondaries – Heart (corrected to transcript)
      { id:'chartres', name:'Chartres Cathedral, France', lat:48.447, lng:1.487, chakra:'heart', level:'secondary', chakraLabel:'Heart', notes:'Structure amplifies an existing vortex.' },
      { id:'avebury', name:'Avebury, England', lat:51.428, lng:-1.854, chakra:'heart', level:'secondary', chakraLabel:'Heart' },
      { id:'rosslyn', name:'Rosslyn Chapel, Scotland', lat:55.855, lng:-3.160, chakra:'heart', level:'secondary', chakraLabel:'Heart' },
      { id:'mont_saint_michel', name:'Mont Saint-Michel, France', lat:48.636, lng:-1.511, chakra:'heart', level:'secondary', chakraLabel:'Heart' },
      { id:'assisi', name:'Assisi, Italy', lat:43.070, lng:12.619, chakra:'heart', level:'secondary', chakraLabel:'Heart' },
      { id:'tuscany', name:'Tuscany hill country, Italy', lat:43.467, lng:11.042, chakra:'heart', level:'secondary', chakraLabel:'Heart', notes:'Bridge between Heart and Crown systems.' },
      { id:'delphi', name:'Delphi, Greece', lat:38.483, lng:22.500, chakra:'heart', level:'secondary', chakraLabel:'Heart' },

      // Secondaries – Throat
      { id:'petra', name:'Petra, Jordan', lat:30.328, lng:35.444, chakra:'throat', level:'secondary', chakraLabel:'Throat' },
      { id:'byblos', name:'Byblos, Lebanon', lat:34.123, lng:35.651, chakra:'throat', level:'secondary', chakraLabel:'Throat' },
      { id:'sinai', name:'Mount Sinai, Egypt', lat:28.539, lng:33.973, chakra:'throat', level:'secondary', chakraLabel:'Throat' },
      { id:'lalibela', name:'Lalibela, Ethiopia', lat:12.031, lng:39.047, chakra:'throat', level:'secondary', chakraLabel:'Throat' },
      { id:'mecca', name:'Mecca, Saudi Arabia', lat:21.389, lng:39.857, chakra:'throat', level:'secondary', chakraLabel:'Throat' },

      // Secondaries – Brow / Third Eye
      { id:'machu_picchu', name:'Machu Picchu, Peru', lat:-13.163, lng:-72.545, chakra:'brow', level:'secondary', chakraLabel:'Brow / Third Eye', notes:'Also carries dual influence with Sacral.' },
      { id:'angkor', name:'Angkor Wat, Cambodia', lat:13.412, lng:103.867, chakra:'brow', level:'secondary', chakraLabel:'Brow / Third Eye' },
      { id:'olympus', name:'Mount Olympus, Greece', lat:40.085, lng:22.358, chakra:'brow', level:'secondary', chakraLabel:'Brow / Third Eye' },
      { id:'athos', name:'Mount Athos, Greece', lat:40.158, lng:24.326, chakra:'brow', level:'secondary', chakraLabel:'Brow / Third Eye' },
      { id:'sedona_brow_zone', name:'Sedona Region, USA (Third Eye areas)', lat:34.95, lng:-111.80, chakra:'brow', level:'secondary', chakraLabel:'Brow / Third Eye', notes:'Selective areas within Sedona carry Third Eye influence in addition to Crown primary.' },

      // Secondaries – Crown
      { id:'taos', name:'Taos, New Mexico, USA', lat:36.494, lng:-105.544, chakra:'crown', level:'secondary', chakraLabel:'Crown' },
      { id:'chaco', name:'Chaco Canyon, New Mexico, USA', lat:36.060, lng:-107.969, chakra:'crown', level:'secondary', chakraLabel:'Crown' },
      { id:'monument_valley', name:'Monument Valley, Arizona/Utah, USA', lat:36.998, lng:-110.098, chakra:'crown', level:'secondary', chakraLabel:'Crown' },
      { id:'big_sur', name:'Big Sur coastline, California, USA', lat:36.270, lng:-121.806, chakra:'crown', level:'secondary', chakraLabel:'Crown' },
      { id:'haleakala', name:'Maui (Haleakalā), Hawaii, USA', lat:20.709, lng:-156.253, chakra:'crown', level:'secondary', chakraLabel:'Crown' }
    ];

    // Lightweight self checks
    (function runSelfChecks(){
      nodes.forEach(n => {
        const latOk = Number.isFinite(n.lat) && n.lat <= 90 && n.lat >= -90;
        const lngOk = Number.isFinite(n.lng) && n.lng <= 180 && n.lng >= -180;
        console.assert(latOk, `Invalid latitude for ${n.id}:`, n.lat);
        console.assert(lngOk, `Invalid longitude for ${n.id}:`, n.lng);
      });
      const ids = new Set();
      nodes.forEach(n => {
        console.assert(!ids.has(n.id), `Duplicate id detected: ${n.id}`);
        ids.add(n.id);
      });
      nodes.forEach(n => {
        console.assert(CHAKRA_COLORS[n.chakra], `Unknown chakra for ${n.id}: ${n.chakra}`);
      });
      console.log('Self-checks completed.');
    })();

    // Build connections: primary to each secondary of same chakra + ring connecting primaries
    const links = [];
    const primaryByChakra = {
      root: 'root_primary',
      sacral: 'sacral_primary',
      solar: 'solar_primary',
      heart: 'heart_primary',
      throat: 'throat_primary',
      brow: 'brow_primary',
      crown: 'crown_primary'
    };

    nodes.forEach(n => { if (n.level === 'secondary') { links.push({ source: primaryByChakra[n.chakra], target: n.id, chakra: n.chakra }); } });

    const primaryIds = Object.values(primaryByChakra);
    for (let i = 0; i < primaryIds.length; i++) {
      const a = primaryIds[i];
      const b = primaryIds[(i + 1) % primaryIds.length];
      links.push({ source: a, target: b, chakra: 'heart', meta:'primary-ring' });
    }

    // Map with panning locked at initial zoom; unlock when zoomed in
    const START_CENTER = [20, 0];
    const START_ZOOM = 2;

    const map = L.map('map', {
      minZoom: START_ZOOM,
      worldCopyJump: false,
      dragging: false,
      inertia: false,
      scrollWheelZoom: true,
      doubleClickZoom: true,
      touchZoom: 'center',
      boxZoom: false,
      keyboard: false,
      zoomControl: true,
      maxBounds: [[-85, -180], [85, 180]],
      maxBoundsViscosity: 1.0
    });

    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
      attribution: '&copy; Carto',
      subdomains: 'abcd',
      maxZoom: 19,
      noWrap: true,
      continuousWorld: false
    }).addTo(map);

    map.setView(START_CENTER, START_ZOOM);

    function updateDragState() {
      if (map.getZoom() > START_ZOOM) {
        map.dragging.enable();
        map.keyboard.enable();
      } else {
        map.dragging.disable();
        map.keyboard.disable();
        map.setView(START_CENTER, START_ZOOM, { animate: false });
      }
    }
    map.on('zoomend', updateDragState);
    map.whenReady(updateDragState);

    // Layers by chakra
    const nodeLayers = {};
    const linkLayers = {};
    Object.keys(CHAKRA_COLORS).forEach(ch => {
      nodeLayers[ch] = L.layerGroup().addTo(map);
      linkLayers[ch] = L.layerGroup().addTo(map);
    });

    // Indices
    const markerById = {};
    const linksByNode = {};

    // Markers
    nodes.forEach(n => {
      const color = CHAKRA_COLORS[n.chakra];
      const marker = L.circleMarker([n.lat, n.lng], {
        radius: n.level === 'primary' ? 9 : 6,
        color: color,
        weight: n.level === 'primary' ? 2.5 : 1.5,
        fillColor: color,
        fillOpacity: n.level === 'primary' ? 0.65 : 0.45
      }).bindPopup(popupHtml(n));

      marker.addTo(nodeLayers[n.chakra]);
      markerById[n.id] = marker;
      linksByNode[n.id] = [];

      marker.on('mouseover', () => highlightConnections(n.id));
      marker.on('mouseout', clearHighlights);
    });

    // Lines
    links.forEach(l => {
      const a = nodes.find(n => n.id === l.source);
      const b = nodes.find(n => n.id === l.target);
      if (!a || !b) return;
      const color = CHAKRA_COLORS[l.chakra];
      const line = L.polyline([[a.lat, a.lng], [b.lat, b.lng]], {
        color: color,
        weight: l.meta === 'primary-ring' ? 1.75 : 1.5,
        opacity: 0.35
      }).addTo(linkLayers[l.chakra]);

      linksByNode[a.id].push(line);
      linksByNode[b.id].push(line);

      line.on('mouseover', () => { line.setStyle({ weight: 4, opacity: 0.9 }); });
      line.on('mouseout', () => { line.setStyle({ weight: l.meta === 'primary-ring' ? 1.75 : 1.5, opacity: 0.35 }); });
    });

    // Hover helpers
    function highlightConnections(nodeId) {
      const lines = linksByNode[nodeId] || [];
      lines.forEach(pl => pl.setStyle({ weight: 4, opacity: 0.9 }));
    }
    function clearHighlights() {
      Object.keys(linkLayers).forEach(ch => {
        linkLayers[ch].eachLayer(pl => {
          const isRing = (pl.options.weight && pl.options.weight > 1.7 && pl.options.opacity < 0.5) ? true : false;
          pl.setStyle({ weight: isRing ? 1.75 : 1.5, opacity: 0.35 });
        });
      });
    }

    // Chakra toggles
    document.querySelectorAll('.toggle').forEach(cb => {
      cb.addEventListener('change', e => {
        const chakra = e.target.getAttribute('data-chakra');
        const checked = e.target.checked;
        if (checked) {
          map.addLayer(nodeLayers[chakra]);
          map.addLayer(linkLayers[chakra]);
        } else {
          map.removeLayer(nodeLayers[chakra]);
          map.removeLayer(linkLayers[chakra]);
        }
      });
    });

    // Primary/Secondary toggles
    const togglePrimaries = document.getElementById('togglePrimaries');
    const toggleSecondaries = document.getElementById('toggleSecondaries');

    togglePrimaries.addEventListener('change', () => {
      const show = togglePrimaries.checked;
      nodes.filter(n => n.level === 'primary').forEach(n => {
        const m = markerById[n.id];
        if (!m) return;
        if (show) { nodeLayers[n.chakra].addLayer(m); }
        else { nodeLayers[n.chakra].removeLayer(m); }
      });
      linkLayers['heart'].eachLayer(pl => {
        if (pl && pl.options && pl.options.weight === 1.75) {
          if (show) { linkLayers['heart'].addLayer(pl); }
          else { linkLayers['heart'].removeLayer(pl); }
        }
      });
    });

    toggleSecondaries.addEventListener('change', () => {
      const show = toggleSecondaries.checked;
      nodes.filter(n => n.level === 'secondary').forEach(n => {
        const m = markerById[n.id];
        if (!m) return;
        if (show) { nodeLayers[n.chakra].addLayer(m); }
        else { nodeLayers[n.chakra].removeLayer(m); }
      });
      Object.keys(linkLayers).forEach(ch => {
        linkLayers[ch].eachLayer(pl => {
          if (pl && pl.options && pl.options.weight === 1.5) {
            if (show) { linkLayers[ch].addLayer(pl); }
            else { linkLayers[ch].removeLayer(pl); }
          }
        });
      });
    });

    // Fit to all points initially
    const bounds = L.latLngBounds(nodes.map(n => [n.lat, n.lng]));
    const INITIAL_PAD = window.innerWidth < 768 ? 0.4 : 0.25;
    map.fitBounds(bounds.pad(INITIAL_PAD));

    // Recompute layout on resize; at world view, keep everything in frame with extra padding on small screens
    function responsiveFit(){
      map.invalidateSize();
      if (map.getZoom() === START_ZOOM && !map.dragging.enabled()) {
        const pad = window.innerWidth < 768 ? 0.4 : 0.25;
        map.fitBounds(bounds.pad(pad));
      }
    }
    window.addEventListener('resize', responsiveFit);

    // Behavior test: drag state follows zoom
    map.once('zoomend', () => {
      const canDrag = map.dragging.enabled();
      console.assert((map.getZoom() === START_ZOOM && !canDrag) || (map.getZoom() > START_ZOOM && canDrag), 'Drag state does not match expected behavior for current zoom level.');
    });
  </script>
</body>
</html>
